\chapter{Realizacja projektu}
\label{cha:realizacja}

Realizacja projektu została podzielony na kilka etapów w których każdy jest zależna od  poprzedniego. Najważniejszymi etapami są: teoretyczne przygotowanie do zagadnienia wraz z doborem topologii sieci, implementacja algorytmu w środowisku MATLAB wraz z algorytmem uczenia sieci oraz ostateczna jego realizacja na układzie fpga. 
\section{Dobór topologii sieci}

Wybór odpowiedniej topologii sieci wymagał znajomości teoretycznej zagadnień związanych z algorytmami opartymi na sieciach neuronowych, wykorzystania własnego doświadczenia związanego z tymi zagadnieniami oraz realizacją algorytmów na układach fpga. Ze względu na niewystarczającą wiedzę w temacie sieci neuronowych, początkowa faza projektu opierała się na poszukiwaniu informacji o zagadnieniach zbliżonych do tematu projektu. Okazało się, iż bardzo zbliżony projekt został już zrealizowany i opisany w \cite{fdciuss}. Artykuł przedstawia dokładne etapy realizacji projektu którego celem było rozpoznawanie twarzy. Zawierał on również dokładny opis topologi sieci oraz sposób przygotowania danych do przetwarzania. 

Informacje te okazały się bardzo pomocne, pozwoliły one rozpocząć doświadczalny dobór topologi sieci, która pozwoli na poprawne przetwarzanie danych wejściowych. 
Podstawą do przeprowadzania takich eksperymentów było zdobycie bazy (została ona załączona wraz z plikami projektu), która umożliwi naukę sieci. Baza posiada zbiór danych przygotowany w formie 4 wartości odpowiadających poszczególnym wartością RGB oraz oczekiwanemu wyjściu z sieci, którego wartości zamykają się w zbiorze {0,1}. Świadczy ono o tym czy na podstawie określonego wejścia powinna zostać wykryta skóra.

Liczna baza danych wypełniona powyżej opisanymi rekordami pozwoliła na przeprowadzanie pierwszych doświadczeń. Na podstawie zdobytych zauważono, iż jakość wykrywania pikseli przedstawiających skórę znacznie wzrasta jeśli na wejście sieci oprócz sygnałów RGB podawane zostaną również CbCr(wartości sygnałów z modelu przestrzeni kolorów YCbCr) oraz HS(wartości sygnałów z przestrzeni barw HSV). Aby otrzymać pełny wektor danych wejściowych zaimplementowano algorytm w postaci skryptu w programie MATLAB, który na podstawie wartości RGB wyznaczał pozostałe parametry. Tak przygotowane dane wejściowe podawano na wejście wbudowanej sieci neuronowej w środowisko MATLAB, a następnie na podstawie przykładowego zdjęcia określano czy sieć poprawnie rozpoznaje skórę na przedstawionym obrazie. Ze względu na łatwą konfigurację topologii sieci sposób ten umożliwił szybkie przetestowanie wielu wariantów oraz wybranie najlepszego w interesującym nas zakresie.

\begin{figure}[tbph!]
	\centering
	\includegraphics[width=0.9\linewidth]{images/matlabnn.jpg}
	\caption{Narzędzie środowiska MATLAB służące do testów sieci neuronowych}
	\label{fig:nnmatlab}
\end{figure}

Najlepsze rezultaty uzyskaliśmy dla sieci posiadającej 7 wejść, 13 neuronów w warstwie ukrytej oraz jednym w warstwie wyjściowej. Niestety narzędzie to uniemożliwia konfigurowanie funkcji wyjścia z neuronu. Na podstawie doświadczeń, zaimplementowanych skryptów oraz zdobytej wiedzy udało się rozpocząć prace nad kolejnym etapem.

\section{Implementacja sieci neuronowej w MATLAB}
W tej fazie skoncentrowano się na implementacji sieci spełniającej nasze wymagania. Ze względu na prostotę działania wybrano sieci propagation o topologii określonej w poprzednim etapie czyli: 7 wejść, 13 neuronów w warstwie ukrytej oraz 1 wyjściu.
Model takiej sieci zakłada prosty przepływ informacji miedzy kolejnymi warstwami, neurony w warstwie wejściowej przekazują wartość na wejścia neuronów w warstwie ukrytej.
Następnie są one przemnażana przez wartość wagi przypisane do wejścia na którym się pojawiła. Wartości te są sumowane w obrębie każdego z neuronów, a następnie przekazywane na wyjście, które ostatecznie na otrzymanej wartości wywołuje funkcje przejścia. Jednoznacznie określona wartość wyjścia przekazywana jest do następnej warstwy (przepływ danych przez sieć przedstawiono na rysunku \ref{fig:nn}).

\begin{figure}[tbph!]
	\centering
	\includegraphics[width=0.7\linewidth]{images/nn.png}
	\caption{Sieć neuronowa typu propagation.}
	\label{fig:nn}
\end{figure} 

W tym przypadku stosowanie sieci o bardziej złożonych strukturach wydaje się zbędny i sprzeczny z intuicją. Sieci te doskonale rozpoznają cechy wartości podanych na wejście co powoduje poprawne zachowanie również dla sygnałów zbliżonych z którymi sieć nie miała wcześniej styczności. 

Ważną cechą sieci jest dobór funkcja przejścia dla neuronów. W tym przypadku została zastosowana funkcja $tanh(x)$ ze względu na jej charakterystykę, która akcentuje wartości brzegowe. W omawianym przypadku odpowiadają wykryciu skóry przez sieć. 

Po implementacji sieci przystąpiono do adaptacji algorytmu uczenia. W sieciach typu propagation najczęsciej stosowany jest algorytm backpropagation, który cechuje się prostą lecz również żmudnymi obliczeniami oraz długimi czasami uczenia sieci. Polega on na podawaniu na wejście sieci wektor odpowiednich wartości, a następnie wyznaczaniu różnicy wyjścia sieci z wartością oczekiwaną. Różnica ta jest przetwarzana wstecznie przez sieć wraz z wyznaczaniem gradientów błędów poszczególnych neuronów. Na ich podstawie korygowane są wagi każdego z wejść neuronów co powoduje uczenie sieci.

Wszystkie skrypty utworzone na tym etapie oraz obszerna baza danych umożliwiły rozpoczęcie prac nad uczeniem sieci. Wywołanie odpowiednich skryptów rozpoczynało proces uczenia sieci, którego czas trwania zależał od ilości wykonania powyżej opisanej operacji dla każdego z wierszy. Optymalne wyniki otrzymane były dla około 100 iteracji dla każdego elementu z bazy danych. Warto również wspomnieć, iż początkowo baza zawierała dane posortowane ze względu na wektor oczekiwanego wyjścia co zdecydowanie utrudniało proces uczenia. Rozwiązano ten problem przez przemieszanie wierszy w bazie.

Na rysunku \ref{fig:reka} przedstawiono przykładowe przetworzenie małego obrazka na którym testowano sieć po zakończeniu uczenia. Na jego podstawie wstępnie oceniano powodzenie procesu uczenia sieci. Jak widać na rysunku udało się osiągnąć zadowalającą jakość. Warto zauważyć, iż zdjęcie testowe zostało wykonane przez autorów projektu więc wartości RGB poszczególnych pikseli są niezależne względem tych umieszczonych w bazie.

\begin{figure}[tbph!]
	\centering
	\includegraphics[width=0.6\linewidth]{images/reka.png}
	\caption{Przykładowy wynik testu działania sieci po uczeniu.}
	\label{fig:reka}
\end{figure}

W kolejnej fazie zmodyfikowano system reprezentacji liczb na których bazuje działanie sieci neuronowej. Zastosowano zmienne typu fixed\_point, które pozwalają na dokładne określenie ilości bitów przeznaczonych na reprezentacje poszczególnej liczby. Do konwersji z typu double do typu fixed\_point został stworzona funkcja w środowisku MATLAB. Jako argument przyjmuje ona zmienną typu double, a następnie na podstawie sztywno określonej konfiguracji funkcji tworzy zmienną typu fixed\_point, która reprezentuje wartość argumentu lub wartość zbliżoną, która jest możliwa do zaprezentowania. Zabieg ten miał na celu dokładne odwzorowanie działania sieci na układzie fpga. Czas przetwarzania obrazu testowego przez sieć, a w szczególności sam proces uczenia wydłużył się kilkakrotnie ze względu na liczne konwersje.

Po przeprowadzaniu ponownego procesu uczenia oraz sprawdzeniu, że modyfikacje te nie zaburzyły w znaczny sposób działania zakończono proces tworzenia odwzorowania sieci w środowisku MATLAB. 

Podczas realizacji tej fazy zorientowano się, iż właściwa implementacja na układzie fpga nie wymaga implementowania procesu uczenia co zdecydowanie upraszcza implementacje. Uzyskane dotychczas informacje na temat topologii sieci, funkcji przejścia, wartości poszczególnych wag dla każdego z neuronów oraz optymalnej ilości bitów przeznaczonych do reprezentacji tych wartości pozwoliły na przystąpienie do ostatniego etapu.

\section{Realizacja algorytmu w środowisku ISE}


